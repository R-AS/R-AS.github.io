---
title: '小程序静默登录'
date: '2021-07-19'
thumbnail: 'mini_program/index.png'
type: '小程序'
---

```toc
```
---
#### 背景
微信官方提供了两种标识用来识别一个用户：
- **OpenId** 是一个用户对于一个小程序/公众号的标识，开发者可以通过这个标识识别出用户。
- **UnionId** 是一个用户对于同主体微信小程序/公众号/APP 的标识，开发者需要在微信开放平台下绑定相同账号的主体。开发者可通过 **UnionId**，实现多个小程序、公众号、甚至 APP 之间的数据互通。

早期，开发者为了拿到 UnionId 而调用 wx.getUserInfo 接口，这导致用户在使用小程序会面临授权弹窗的困扰。而这种做法会导致以下结果：
- 开发者在小程序首页直接调用 wx.getUserInfo 进行授权，弹窗获取用户信息，会使得一部分用户点击“拒绝”按钮。
- 在开发者没有处理用户拒绝弹框的情况下，用户必须授权头像昵称等信息才能继续使用小程序，会导致某些用户放弃使用该小程序。
- 用户没有很好的方式重新授权，尽管微信官方增加了设置页面，可以让用户选择重新授权，但很多用户并不知道可以这么操作。

针对以上问题，衍生出**静默登录**和**用户登录**两种概念。

---

#### 静默登录
小程序可以通过微信官方提供的登录能力方便地获取微信提供的用户身份标识，快速建立小程序内的用户体系。

在**wx.login**获取到**code**后，会发送到后端，后端通过接口去微信后端换取**openid**和**sessionKey**(现在会将**unionid**也一并放回)后，把自定义登录态**3rd_session**（本业务命名为**auth-token**）放回给前端，就已经完成登录行为了。

以下是官方给出的 wx.login 的最佳实践：
![pic_1](/blogs/mini_program/mini_2_pic_1.png#pic_center)

总结为以下三步：
- 小程序端调用 **wx.login()** 获取 临时登录凭证**code**，并回传到开发者服务器。
- 服务器端调用 **auth.code2Session** 接口，换取 用户唯一标识 **OpenID** 和 会话密钥 **session_key**。
- 开发者服务器可以根据用户标识来生成自定义登录态(例如：**auth-token**)，用于后续业务逻辑中前后端交互时识别用户身份。

---
**转载自：**
- [https://juejin.cn/post/6933082931653148680](https://juejin.cn/post/6933082931653148680)